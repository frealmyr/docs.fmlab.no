### Why PiHole?

If you are like me, and are a big fan of self-hosting applications, then you want to [read up on PiHole.](https://www.google.com/search?client=firefox-b-d&q=what+is+pihole)

In short, PiHole is a self-hosted DNS server that blocks ads using blocklists or regex syntaxes. It also functions as a [caching DNS server](https://www.digitalocean.com/community/tutorials/a-comparison-of-dns-server-types-how-to-choose-the-right-dns-configuration#functional-differences) for your local network, speeding up re-occurring DNS lookups for all your devices.

PiHole runs a modified version of [dnsmasq](https://en.wikipedia.org/wiki/Dnsmasq), which i also also use for resolving `.lab` DNS A record requests in my homelab. Which pairs with my Traefik setup for resolving applications that are only available in my local network.

If you **do not wish to use PiHole**, but still want to use my Traefik guide for `.lab` local network resolving, you will need to set up a DNS server yourself. Or add records to your router if it supports that.

### Docker-compose

First, create the folder structure that we will use for pihole

```bash
mkdir -p $HOME/Homelab/System/pihole/config/pihole \
  && mkdir $HOME/Homelab/System/pihole/config/dnsmasq.d \
  && cd $HOME/Homelab/System/pihole \
``` 

Inside the pihole folder, we can now create the `docker-compose.yml` file for pihole. We will also make use of a `.env` file here for the variables, which looks `${LIKE_THIS}`.

```yaml
version: '3.5'

networks:
  lab:
    external: true

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    dns:
      - 127.0.0.1
      - ${DNS1}
    ports:
      - ${SERVER_IP}:53:53/tcp
      - ${SERVER_IP}:53:53/udp
    networks:
      - lab
    volumes:
      - ./config/pihole:/etc/pihole/
      - ./config/dnsmasq.d:/etc/dnsmasq.d/
      - /var/log/pihole:/var/log/
    environment:
      TZ: ${TZ}
      DNS1: ${DNS1}
      DNS2: ${DNS2}
      IPv6: False
      ServerIP: ${SERVER_IP}
      VIRTUAL_HOST: ${PROJECT}.${DOMAIN}
      VIRTUAL_PORT: 80
      WEBPASSWORD: ${WEBPASSWORD}
    labels:
      - traefik.enable=true
      - traefik.http.routers.${PROJECT}.entryPoints=http
      - traefik.http.routers.${PROJECT}.rule=Host(`${PROJECT}.${DOMAIN}`)
      - traefik.http.services.${PROJECT}.loadbalancer.server.port=80
    restart: unless-stopped
```

| Line | Description   |
| :--------------- | :------ |
| L3:L5 | Since we want to visit PiHole using Traefik, we mount the external lab network. |
| L11:L13 | Set the container resolve settings to localhost and a backup server in case dnsmasq starts failing |
| L14:L16 | Bind port 53 tcp/udp to the host, if you remove the ip-address you will get a port conflict from the host dns client |
| L19:L22 | Store PiHole and dnsmasq in a config folder, for easy access. Also mount logs to /var/log, can be commented out or mounted to /tmp. |
| L24 | The timezone for logs and metrics. |
| L25 | Primary upstream DNS server, can be your ISP or Google etc. |
| L26 | Secondary upstream DNS server. |
| L27 | I don't use IPv6, so i leave this toggled off. |
| L28 | Server IP for dnsmasq |
| L29:L30 | PiHole's web server should listen for this domain and port |
| L31 | Password for the PiHole GUI |

Create a `.env` file in the same folder, docker-compose will detect this file and use it for the variables in the `docker-compose.yml` file

```bash
# Project
PROJECT=pihole
DOMAIN=lab
PORT=80

# Pihole
SERVER_IP=10.0.0.32
DNS1=8.8.8.8
DNS2=8.8.4.4
TZ=Europe/Oslo
WEBPASSWORD=supersekretpassword
```

>Note that the password is stored in plaintext, look up [docker secrets](https://docs.docker.com/engine/swarm/secrets/) if you are concerned by this.

### Configuration

You can now run `docker-compose up` to boot up pihole for the first time, and generate the configuration files inside the `./config` folder

  >If you do not have Traefik running from the previous guide, you'll need to add a port-forward for port 80 on the container for accessing the GUI.

If the logs looks good, you can now try to set the host ip address as the DNS server for another device. If pihole works properly, websites should resolve like normal, and you have successfully configurated pihole.

We can now add records to dnsmasq for resolving `.lab` requests. Navigate to the `./config/dnsmasq.d` folder.

Inside this folder, there should only be one file called `01-pihole.conf`, which is auto-generated by pihole. **However, do not** edit this file manually, instead create a new file when you want to make additonal changes to dnsmasq, as it will pick up every file inside this directory. 

Create the file `10-lan_records.conf` and add the following

```bash
address=/.lab/10.0.0.32
address=/router.lab/10.0.0.1
address=/3d.lab/10.0.0.33
```

The first line states that the record `.lab` resolves to `10.0.0.32`, which is my server. 
For overriding this record, we can add additional lines with records that overrides this record, which is useful for services that are not hosted from our server. In the example, I have added my router and a [Octoprint](https://octoprint.org/) server.

You can now run `docker-compose up -d`, and again check if the DNS server works from another client.

If you have done all the steps correctly, you should now be able to visit `http://traefik.lab` and `http://pihole.lab/admin` from a client which uses PiHole as their DNS server.
